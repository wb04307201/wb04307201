# MySQL数据库

## 一、MySQL 数据库介绍

MySQL 是一个广泛使用的**开源关系型数据库管理系统**，由瑞典 MySQL AB 公司开发，目前属于 Oracle 公司。它是最流行的数据库之一，尤其在 Web 应用开发中扮演着核心角色（如经典的 LAMP/LNMP 架构），以其高性能、高可靠性和易用性而著称。

**核心特点**：
*   **开源免费**：社区版（MySQL Community Server）可免费使用，降低了成本。
*   **高性能**：尤其在处理读密集型操作时表现优异。
*   **稳定可靠**：经过长期、大规模生产环境的考验。
*   **跨平台**：支持 Linux、Windows、macOS 等多种操作系统。
*   **可扩展性**：支持主从复制、集群等方案，能够处理海量数据和高并发请求。
*   **强大的社区支持**：拥有庞大的开发者社区和丰富的文档资源。
*   **灵活的存储引擎**：提供多种可插拔的存储引擎，可根据不同应用场景选择最合适的引擎。

---

## 二、MySQL 架构

MySQL 的逻辑架构分为两层，这种设计实现了“服务器层”与“存储引擎层”的分离，提供了极大的灵活性。

**1. Server 层（连接与服务层）**
这一层包含了 MySQL 大多数核心服务功能，所有跨存储引擎的功能都在此实现，如：
*   **连接器**：负责与客户端建立连接、权限验证和线程管理。它通过一个**线程池**来管理连接线程，以提高性能，避免频繁创建和销毁线程的开销。
*   **服务缓存**：在 MySQL 8.0 之前，这里有一个查询缓存（Query Cache），但因在频繁更新的场景下效率低下，在 8.0 版本中已被移除。
*   **分析器**：对 SQL 语句进行解析，包括**词法分析**（识别关键字）和**语法分析**（检查语法是否正确）。
*   **优化器**：在表有多个索引或多表关联（JOIN）时，决定使用哪个索引或表的连接顺序，生成最优的执行计划。
*   **执行器**：根据优化器生成的执行计划，调用存储引擎提供的接口来执行 SQL 语句。
*   **其他功能**：存储过程、触发器、视图、函数、二进制日志（binlog）等。

**2. 存储引擎层**
这一层负责数据的存储和提取。MySQL 支持**插件式存储引擎**，允许你为不同的表选择不同的存储引擎。常见的引擎有：
*   **InnoDB**：默认引擎，支持事务、行级锁和外键。
*   **MyISAM**：早期默认引擎，不支持事务和行级锁，读性能高。
*   **Memory**：内存存储引擎，速度极快，但服务器重启后数据会丢失。
*   **Archive**：适用于存储大量归档数据，压缩率高。

这种分层架构的好处是，你可以根据业务需求（如是否需要事务、读写比例等）自由选择最合适的存储引擎，而上层的服务和应用逻辑无需改动。

---

## 三、主要存储引擎

**1. InnoDB（默认引擎）**
*   **特点**：支持**ACID 事务**、**行级锁**、**外键约束**。采用多版本并发控制（MVCC）来实现高并发，默认隔离级别为**可重复读**，通过间隙锁避免幻读。
*   **存储方式**：基于**聚簇索引**建立，数据文件本身就是索引文件。表数据存储在 `.ibd` 文件中（MySQL 5.7+ 默认独立表空间）。
*   **适用场景**：需要事务支持、高并发读写、数据一致性要求高的场景（如电商系统、银行系统）。

**2. MyISAM（5.5 版本前的默认引擎）**
*   **特点**：**不支持事务**和**行级锁**，只支持**表级锁**。读写时会锁定整个表，并发写入效率低。不支持外键。
*   **存储方式**：索引与数据分离。表结构存于 `.frm` 文件，数据存于 `.MYD` 文件，索引存于 `.MYI` 文件。
*   **适用场景**：读多写少、不需要事务的场景（如数据仓库、日志分析、全文搜索）。

**3. Memory（HEAP）**
*   **特点**：将所有数据存储在内存中，速度极快。支持**表级锁**，不支持 BLOB/TEXT 等大字段类型。服务器重启后数据会丢失。
*   **适用场景**：临时表、缓存中间结果、映射表等对数据持久性无要求的场景。

**4. Archive**
*   **特点**：使用 `zlib` 无损压缩算法，压缩率非常高（约比 MyISAM 小 75%）。**只支持 INSERT 和 SELECT** 操作，不支持 UPDATE 和 DELETE（行被删除后会在后台进行空间整理）。
*   **适用场景**：存储大量的、很少访问的归档数据或日志信息。

---

## 总结与选择建议

| 特性       | InnoDB      | MyISAM   | Memory  | Archive        |
|:---------|:------------|:---------|:--------|:---------------|
| **事务**   | **支持**      | 不支持      | 不支持     | 不支持            |
| **锁粒度**  | **行级锁**     | 表级锁      | 表级锁     | 行级锁（但仅限INSERT） |
| **外键**   | **支持**      | 不支持      | 不支持     | 不支持            |
| **崩溃恢复** | **支持**      | 不支持      | 不支持     | 不支持            |
| **全文索引** | 5.6+ 版本支持   | **支持**   | 不支持     | 不支持            |
| **主要用途** | 通用、事务安全、高并发 | 读密集、静态数据 | 临时数据、缓存 | 归档、日志          |

**如何选择？**
*   **默认选择 InnoDB**：除非有非常特殊的理由，否则 InnoDB 因其对事务和数据完整性的支持，应作为绝大多数场景的首选。
*   **考虑 MyISAM**：仅当你的应用**完全不需要事务**，且**以读操作为主**，对**全文搜索**有强需求时。
*   **考虑 Memory**：仅用于临时存储、可再生的中间数据。
*   **考虑 Archive**：仅用于存储大量**只写不改**的归档数据。

你可以通过 `SHOW CREATE TABLE table_name;` 查看表的当前存储引擎，并使用 `ALTER TABLE table_name ENGINE = InnoDB;` 来修改表的存储引擎。