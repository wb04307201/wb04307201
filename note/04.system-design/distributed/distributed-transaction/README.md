# 分布式事务

分布式事务是指跨越多个服务、数据库或系统边界，需要保证这些独立操作要么全部成功、要么全部失败的事务处理机制。在分布式系统中，由于数据分散、网络延迟、节点故障等复杂性，传统单机事务的ACID特性（原子性、一致性、隔离性、持久性）难以直接应用，因此需要专门的解决方案。

## 一、 核心概念
1. **ACID的挑战**：
    - **原子性**：单机事务通过锁或日志实现，但分布式系统中跨节点协调困难。
    - **一致性**：多节点数据同步延迟可能导致临时不一致。
    - **隔离性**：分布式环境下难以实现全局锁。
    - **持久性**：多节点写入需确保所有节点均持久化成功。

2. **CAP定理的权衡**：
    - 分布式系统无法同时满足一致性（Consistency）、可用性（Availability）和分区容错性（Partition Tolerance），需根据业务场景选择优先级。

## 二、 常见解决方案
### 1. 两阶段提交（2PC, Two-Phase Commit）
- **流程**：
    1. **准备阶段**：协调者询问所有参与者是否可提交，参与者锁资源并返回结果。
    2. **提交阶段**：若所有参与者同意，协调者发送提交命令；否则回滚。
- **优点**：强一致性。
- **缺点**：
    - 同步阻塞：参与者需等待协调者指令，期间资源被锁定。
    - 单点故障：协调者崩溃可能导致数据不一致。
    - 脑裂问题：网络分区可能导致部分节点提交、部分回滚。

### 2. 三阶段提交（3PC, Three-Phase Commit）
- **改进**：
    - 增加**预提交阶段**，减少阻塞时间。
    - 通过超时机制处理协调者故障。
- **问题**：仍无法完全避免脑裂，且实现复杂。

### 3. TCC（Try-Confirm-Cancel）
- **流程**：
    1. **Try**：预留资源（如冻结账户余额）。
    2. **Confirm**：确认执行（如扣款）。
    3. **Cancel**：取消预留（如解冻余额）。
- **优点**：
    - 适用于高并发场景（如支付、订单）。
    - 非阻塞，可异步处理。
- **缺点**：
    - 业务侵入性强，需为每个操作编写补偿逻辑。
    - 空回滚/悬挂问题需额外处理。

### 4. SAGA 模式
- **流程**：
    - 将长事务拆分为多个本地事务，按顺序执行。
    - 若某一步失败，通过补偿事务回滚已执行操作。
- **优点**：
    - 无需协调者，适合跨服务调用。
    - 灵活性高，可自定义补偿逻辑。
- **缺点**：
    - 事务链长时，补偿逻辑复杂。
    - 最终一致性，中间状态可能被用户感知。

### 5. 本地消息表 + 事件驱动
- **流程**：
    1. 将分布式事务拆分为本地事务和消息发送。
    2. 通过消息队列（如Kafka、RocketMQ）异步通知其他服务。
    3. 消费者处理消息并更新本地数据。
- **优点**：
    - 解耦服务，提高吞吐量。
    - 支持最终一致性。
- **缺点**：
    - 需处理消息重复消费、丢失等问题。
    - 依赖消息队列的可靠性。

### 6. Seata（阿里开源框架）
- **核心组件**：
    - **TC（Transaction Coordinator）**：全局事务协调器。
    - **TM（Transaction Manager）**：定义全局事务范围。
    - **RM（Resource Manager）**：管理分支事务。
- **模式**：
    - **AT模式**：基于SQL解析自动生成回滚日志，类似2PC但无阻塞。
    - **TCC模式**：支持自定义Try/Confirm/Cancel。
    - **SAGA模式**：长事务流程编排。

## 三、 选型建议**
| 场景        | 推荐方案           | 特点            |
|-----------|----------------|---------------|
| 强一致性要求高   | 2PC、Seata AT模式 | 同步阻塞，适合金融核心交易 |
| 高并发、最终一致性 | TCC、SAGA、本地消息表 | 异步非阻塞，适合电商、物流 |
| 跨服务调用     | SAGA、事件驱动      | 灵活性高，需处理补偿逻辑  |
| 简单业务      | 本地消息表          | 实现简单，但扩展性有限   |

## 四、 实践中的问题
1. **超时与重试**：需合理设置超时时间，避免重复操作导致数据错误。
2. **幂等性设计**：确保消息重复消费或重试时结果一致。
3. **监控与回滚**：实时监控事务状态，快速定位失败原因并回滚。
4. **测试覆盖**：模拟网络分区、节点故障等异常场景。

## 五、 总结
分布式事务是分布式系统的核心挑战之一，选择方案时需权衡一致性、可用性和性能。对于强一致性场景，可优先考虑Seata AT或2PC；对于高并发最终一致性场景，TCC或事件驱动更合适。实际项目中，往往结合多种模式（如Seata AT + TCC）以满足复杂业务需求。